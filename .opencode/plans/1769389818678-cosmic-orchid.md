# Handoff Plugin Code Review - Critical Fixes

## Summary

Three code review subagents analyzed `plugin/handoff.ts` for amp parity, concurrency safety, and UX/error handling. Oracle validated findings. **3 high-priority issues require fixes before deployment**, 2 medium-priority for post-deployment.

## Validated Critical Issues (HIGH - Pre-Deployment)

### 1. Type Safety Violation (Line 296)
**Issue**: Uses `(m.info as any).finish` which violates "never compromise type safety" rule from AGENTS.md.

**Impact**: 
- Bypasses TypeScript safety
- Undocumented API dependency
- Runtime errors if API changes

**Fix**: Add proper interface (pattern exists in `preemptive-compaction.ts:16`):
```typescript
interface AssistantMessageInfo extends MessageInfo {
  role: "assistant";
  finish?: string;
}

// Then use type guard instead of 'any' cast
function isCompletedAssistantMsg(msg: MessageWithParts): boolean {
  return msg.info.role === "assistant" &&
         'finish' in msg.info &&
         (msg.info as AssistantMessageInfo).finish !== undefined;
}

// Line 293-298: Replace with
const assistantMsg = msgs.find(m => 
  isCompletedAssistantMsg(m) &&
  m.parts.some(p => p.type === "text" && (p.content?.length ?? 0) > 50)
);
```

**Files**:
- `plugin/handoff.ts` lines 26-30 (add interface), 293-298 (use type guard)

---

### 2. Silent TUI Failures (Lines 414-417)
**Issue**: `clearPrompt()` and `appendPrompt()` can fail, but user sees "Handoff ready!" even if prompt injection failed.

**Impact**:
- User presses Enter expecting handoff
- Gets empty or stale prompt
- Confusing failure mode

**Fix**: Wrap TUI operations in try/catch:
```typescript
try {
  await ctx.client.tui.clearPrompt();
  await ctx.client.tui.appendPrompt({
    body: { text: `/new ${summary}` }
  });
  return `Handoff ready! Press Enter to start new session.`;
} catch (tuiError) {
  console.error("[handoff] TUI injection failed:", tuiError);
  return `Handoff summary created but prompt injection failed. Copy this to new session:\n\n/new ${summary}`;
}
```

**Files**:
- `plugin/handoff.ts` lines 413-419

---

### 3. Abort Signal Ignored (Line 389, 284-320)
**Issue**: `context.abort` signal passed but never checked in polling loop. If user cancels, operation continues for full 30s.

**Impact**:
- Wastes API calls after cancellation
- Delayed cleanup
- Poor UX (appears hung)

**Fix**: Check abort in polling loop:
```typescript
// Line 286
while (Date.now() - startTime < 30000) {
  if (context.abort.aborted) {
    throw new Error("Handoff cancelled by user");
  }
  
  const msgsResult = await ctx.client.session.messages({
    path: { id: tempSessionID },
    query: { directory: ctx.directory },
  });
  // ... rest of loop
}
```

**Files**:
- `plugin/handoff.ts` line 286 (add check inside while loop)

---

## Medium Priority Issues (Post-Deployment)

### 4. Misleading Success on Fallback (Lines 338-342)
**Issue**: When LLM fails, returns empty context but says "Handoff ready!"

**Fix**: Communicate degradation to user:
```typescript
} catch (error) {
  console.error("[handoff] LLM summarization failed:", error);
  const fallbackPrompt = assembleHandoffPrompt(sessionID, goal, 
    "(LLM summary unavailable - using basic context)", 
    [], 
    files
  );
  
  try {
    await ctx.client.tui.clearPrompt();
    await ctx.client.tui.appendPrompt({ body: { text: `/new ${fallbackPrompt}` } });
    return `Handoff ready (basic mode - LLM summary failed). Press Enter to continue.`;
  } catch (tuiError) {
    return `Handoff summary (basic): ${fallbackPrompt}`;
  }
}
```

---

### 5. File Limit Mismatch (Lines 88, 358)
**Issue**: `extractFilePaths()` returns 20 files, but `assembleHandoffPrompt()` only uses 10. Wastes extraction work.

**Fix**: Align limits:
```typescript
// Line 88
return Array.from(files).slice(0, 10); // Match amp's max and assembleHandoffPrompt
```

---

## Race Condition Analysis (Reviewed but LOW priority)

### Module-Level State (Lines 9, 269, 327, 439-441)
**Issue**: `handoffTempSessionID` shared across concurrent handoffs.

**Oracle Analysis**: 
- Accurate but **overrated severity**
- Single-user CLI context makes concurrent handoffs unlikely
- Would require two users invoking handoff within same 30s window
- Temperature fails silently (1.0 instead of 0.1) but handoff still works

**Decision**: Monitor in production. If concurrent usage increases, refactor to `Set<string>`:
```typescript
// Future fix if needed
const handoffTempSessionIDs = new Set<string>();

// L269: handoffTempSessionIDs.add(tempSessionID);
// L327: handoffTempSessionIDs.delete(tempSessionID);  
// L439: if (handoffTempSessionIDs.has(input.sessionID))
```

---

## False Positives (Ignore)

1. **Resource leaks** - `finally` block correctly cleans up (L325-336)
2. **Cleanup timing issues** - Clearing flag before delete is correct (prevents hook applying during cleanup)
3. **No early cleanup** - Pattern is correct (nothing to clean before session creation)
4. **Fragile streaming detection** - Duplicate of type safety issue #1

---

## Amp Parity Assessment

| Feature | Amp | This Implementation | Status |
|---------|-----|---------------------|--------|
| Temperature 0.1 | ✅ | ✅ (via hook) | Match |
| Forced tool call | ✅ | ❌ (JSON prompt) | SDK limitation |
| First-person context | ✅ | ✅ | Match |
| File prioritization | ✅ | ✅ (LLM first) | Match |
| Context assembly | ✅ | ✅ | Match |
| Session reference | ✅ | ✅ | Match |
| Max 10 files | ✅ | ✅ (after fix #5) | Match |

**Verdict**: Implementation matches amp's approach within OpenCode SDK constraints. JSON-based tool calling is acceptable fallback (~90%+ success rate with fallback parser).

---

## Implementation Plan

### Phase 1: Critical Fixes (Effort: 45 min)

1. **Add AssistantMessageInfo interface** and type guard
   - Location: `plugin/handoff.ts` after line 30
   - Replace line 296 with type-safe check

2. **Wrap TUI operations in try/catch**
   - Location: `plugin/handoff.ts` lines 413-419
   - Return fallback message with summary if injection fails

3. **Add abort signal check to polling loop**
   - Location: `plugin/handoff.ts` line 286 (inside while loop)
   - Throw cancellation error if `context.abort.aborted`

### Phase 2: Medium Priority (Effort: 30 min)

4. **Improve fallback messaging**
   - Location: `plugin/handoff.ts` lines 338-342
   - Communicate degraded mode to user

5. **Fix file limit consistency**
   - Location: `plugin/handoff.ts` line 88
   - Change 20 → 10

---

## Verification Steps

### Test Scenario 1: Happy Path
```bash
# In OpenCode session with conversation history
1. Type: "use handoff tool with goal 'continue auth work'"
2. Wait for "Handoff ready!" message
3. Press Enter
4. Verify: New session starts with @file mentions + context + goal
```

### Test Scenario 2: TUI Failure
```bash
# Simulate TUI API failure (mock)
1. Invoke handoff
2. Verify: Falls back to displaying summary for copy-paste
3. Verify: User can manually /new with the summary
```

### Test Scenario 3: Abort
```bash
1. Invoke handoff with long conversation
2. Cancel operation (Ctrl+C or abort signal)
3. Verify: Polling stops immediately
4. Verify: Cleanup runs (temp session deleted)
```

### Test Scenario 4: LLM Timeout
```bash
# Use very long conversation or complex goal
1. Invoke handoff
2. Wait 30s
3. Verify: Returns fallback context (not empty)
4. Verify: Message indicates degraded mode
```

### Test Scenario 5: Type Safety
```bash
# Visual verification
1. Check TypeScript compilation has no errors
2. Check no 'any' type casts remain in final code
3. Verify finish property properly typed
```

---

## Files to Modify

- `plugin/handoff.ts` (all changes)

## Estimated Total Effort

- **P0 (Critical)**: 45 minutes
- **P1 (Medium)**: 30 minutes
- **Total**: ~1.25 hours

---

## Risk Assessment

**Low Risk Changes**:
- Type interface addition (additive, no breaking changes)
- TUI error handling (defensive, improves UX)
- Abort signal (respects existing signal contract)

**No Breaking Changes**: All fixes are internal improvements.

---

## Deferred Items

- Race condition fix (low probability in single-user context)
- Polling optimization (current perf acceptable)
- Magic number extraction (code clarity, not critical)

Monitor usage patterns and revisit if concurrent handoffs become common.

---

## Post-Implementation Review Results

### Three-Subagent Code Review ✅

**Review 1 (Critical Fixes)**: All PASS
- Type safety: `AssistantMessageInfo` interface + type guard ✓
- TUI error handling: Try/catch with fallback ✓
- Abort signal: Checked in polling loop ✓

**Review 2 (Medium Priority)**: All PASS
- Fallback messaging: Clear degraded mode indication ✓
- File limit consistency: 10 files throughout ✓

**Review 3 (Amp Parity)**: All PASS, No Regressions
- Temperature control via hook ✓
- Context assembly order correct ✓
- First-person extraction maintained ✓
- File limits consistent ✓
- Graceful degradation preserved ✓

### Oracle Final Validation ✅

**Verdict**: "No further action needed. The implementation is solid."

**Analysis**:
- All critical and medium priority fixes correctly implemented
- Type safety properly enforced (no unsafe `any` casts at boundaries)
- Error handling covers all failure modes
- Amp parity fully maintained
- Edge cases handled (empty messages, timeout, TUI failure, malformed JSON)

**Minor Style Note** (not requiring fix):
- Line 49 type assertion is safe and guarded by runtime check
- Proper fix would add complexity without material benefit

### Implementation Quality

- ✅ TypeScript compiles without errors
- ✅ All planned fixes applied correctly
- ✅ No regressions introduced
- ✅ Graceful degradation paths working
- ✅ User feedback clear for all failure modes

**Status**: Ready for use. All critical safety and UX issues resolved.
